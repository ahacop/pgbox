# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

pgbox is a Go CLI application that simplifies running PostgreSQL in Docker with selectable extensions. It manages Docker containers with PostgreSQL instances and can install extensions from the apt.postgresql.org repository.

## Build and Development Commands

```bash
# Build the binary
make build

# Run tests
make test

# Run tests with coverage
make test-coverage

# Run all quality checks (format, vet, test)
make check

# Format code
make fmt

# Run linter (requires golangci-lint)
make lint

# Development build and run
make dev

# Clean build artifacts
make clean

# Install binary to GOPATH/bin
make install

# Update extension catalogs from Docker images
make update-extensions
```

## Key Commands

```bash
# Start PostgreSQL with extensions
./pgbox up --ext pgvector,hypopg

# Connect to PostgreSQL with psql
./pgbox psql

# Stop containers
./pgbox down

# Export Docker artifacts
./pgbox export --dir ./my-postgres

# List available extensions
./pgbox list-extensions

# Check container status
./pgbox status

# View container logs
./pgbox logs
```

## Architecture

### Command Layer (`cmd/`)
- **root.go**: Main command structure with version info
- **up.go**: Starts PostgreSQL containers with optional extensions (builds custom Docker images when needed)
- **down.go**: Stops and optionally removes containers
- **psql.go**: Connects to running PostgreSQL instance with psql client
- **export.go**: Exports Dockerfile, docker-compose.yml, and init.sql for standalone use
- **list_extensions.go**: Lists available PostgreSQL extensions
- **status.go**, **logs.go**, **restart.go**, **clean.go**: Container management commands

### Internal Components (`internal/`)
- **config/postgres.go**: PostgreSQL configuration management (version, port, credentials)
- **container/manager.go**: Container naming and selection logic
- **docker/client.go**: Docker command wrapper for container operations
- **extensions/**: Extension management
  - **extensions.go**: Manager for validating extensions and determining required packages
  - **loader.go**: Loads embedded extension metadata from extensions.jsonl

### Package Components (`pkg/`)
- **scaffold/templates.go**: Go template-based generation of Docker artifacts (Dockerfile, docker-compose.yml, init.sql)

## Extension System

Extensions are embedded in the binary via `extensions.jsonl` (generated by scripts). The system:
1. Validates requested extensions against available packages
2. Builds custom Docker images with required apt packages when extensions are specified
3. Generates init.sql to CREATE EXTENSION statements
4. Maps extension names to their SQL names (e.g., "pgvector" â†’ "vector")

## Docker Integration

When extensions are requested:
1. Creates a temporary build directory with generated Dockerfile
2. Builds a custom image based on postgres:XX-bookworm with apt packages
3. Mounts init.sql for automatic extension creation
4. Uses Docker volumes for data persistence

## Testing

- Unit tests use testify for assertions
- Docker client has comprehensive tests for command building
- Template generation is tested for various configurations